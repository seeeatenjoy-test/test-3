<!DOCTYPE html>
<html lang="en">
<head>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    <title>AR Dish Selector</title>
    <!-- Include Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Lato:wght@400;700&display=swap" rel="stylesheet">
    <!-- Include FontAwesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Include jQuery before Select2 -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <!-- Include Select2 for a better dropdown -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <!-- Include three.js library -->
    <script src='js/three.js'></script>
    <script src='js/OBJLoader.js'></script>
    <script src='js/MTLLoader.js'></script>
    <!-- include jsartoolkit -->
    <script src="jsartoolkit5/artoolkit.min.js"></script>
    <script src="jsartoolkit5/artoolkit.api.js"></script>
    <!-- include threex.artoolkit -->
    <script src="threex/threex-artoolkitsource.js"></script>
    <script src="threex/threex-artoolkitcontext.js"></script>
    <script src="threex/threex-arbasecontrols.js"></script>
    <script src="threex/threex-armarkercontrols.js"></script>
    <style>
        /* General styles */
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Lato', sans-serif;
            display: flex;
            flex-direction: column;
            height: 100vh;
            background-color: #000000;
            color: #ffffff;
        }

        /* Top bar styles */
        #top-bar {
            height: 80px;
            background: linear-gradient(to right, #111111, #222222);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 20px;
            box-shadow: 0 2px 5px rgba(255, 255, 255, 0.1);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            z-index: 10;
            position: relative;
        }

        #top-bar .back-button {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 20px;
            cursor: pointer;
            font-weight: 500;
            position: absolute;
            left: 20px;
            transition: transform 0.2s ease;
        }

        #top-bar .back-button:hover {
            transform: scale(1.1);
        }

        #top-bar .logo {
            font-size: 28px;
            font-weight: 700;
            color: #ffffff;
            font-family: 'Playfair Display', serif;
            text-align: center;
        }

        /* Camera section styles */
        #camera-section {
            flex: 1;
            max-height: 50vh; /* Restrict to top half of the screen */
            position: relative;
            overflow: hidden;
            border: 2px solid #333333;
            box-sizing: border-box;
            background-color: #000000;
            margin: 20px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
            z-index: 1; /* Ensure it's above other elements */
        }

        /* Dropdown section styles */
        #dropdown-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 20px;
            z-index: 0; /* Ensure it's below the camera section */
        }

        /* Dropdown heading styles */
        #dropdown-heading {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 10px;
            color: #ffffff;
            font-family: 'Playfair Display', serif;
        }

        /* Dropdown styles */
        .select2-container {
            width: 250px !important;
        }

        .select2-selection {
            border: 2px solid #444444 !important;
            border-radius: 10px !important;
            height: 45px !important;
            display: flex !important;
            align-items: center !important;
            background-color: #222222 !important;
            color: #ffffff !important;
        }

        .select2-selection__arrow {
            height: 43px !important;
            color: #ffffff !important;
        }

        .select2-dropdown {
            border: 2px solid #444444 !important;
            border-radius: 10px !important;
            box-shadow: 0 4px 20px rgba(255, 255, 255, 0.1);
            background-color: #222222 !important;
        }

        .select2-results__option {
            color: #ffffff !important;
        }

        .select2-results__option--highlighted {
            background-color: #444444 !important;
        }

        /* Popular dishes section styles */
        #popular-dishes-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 20px;
            z-index: 0; /* Ensure it's below the camera section */
        }

        #popular-dishes-heading {
            font-size: 18px;
            font-weight: 500;
            margin-bottom: 10px;
            color: #ffffff;
            font-family: 'Playfair Display', serif;
        }

        /* Carousel styles */
        #carousel {
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            width: 100%;
            max-width: 600px;
            margin: 0 auto;
        }

        #carousel-container {
            display: flex;
            overflow: hidden;
            width: 100%;
            scroll-behavior: smooth;
        }

        .carousel-item {
            flex: 0 0 auto;
            width: 150px;
            height: 150px;
            margin: 0 10px;
            border-radius: 10px;
            background-color: #333333;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #ffffff;
            font-size: 18px;
            font-weight: 500;
        }

        .carousel-arrow {
            background: none;
            border: none;
            color: #ffffff;
            font-size: 24px;
            cursor: pointer;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            transition: transform 0.2s ease;
        }

        .carousel-arrow:hover {
            transform: translateY(-50%) scale(1.1);
        }

        .carousel-arrow.left {
            left: -30px;
        }

        .carousel-arrow.right {
            right: -30px;
        }

        /* Canvas styles */
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            z-index: 0;
        }
    </style>
</head>
<body>

<!-- Top Bar -->
<div id="top-bar">
    <button class="back-button" onclick="window.history.back()"><i class="fas fa-arrow-left"></i></button>
    <div class="logo">AR Dish Selector</div>
</div>

<!-- Camera Section -->
<div id="camera-section">
    <!-- The renderer will be appended here by three.js -->
</div>

<!-- Dropdown Section -->
<div id="dropdown-section">
    <div id="dropdown-heading">Select a Dish</div>
    <select id="dropdown-menu">
        <option value="fish">Fish</option>
        <option value="cube">Cube</option>
    </select>
</div>

<!-- Popular Dishes Section -->
<div id="popular-dishes-section">
    <div id="popular-dishes-heading">Popular Dishes at XYZ Restaurant</div>
    <div id="carousel">
        <button class="carousel-arrow left" onclick="scrollCarousel(-1)">&#10094;</button>
        <div id="carousel-container">
            <div class="carousel-item">Dish 1</div>
            <div class="carousel-item">Dish 2</div>
            <div class="carousel-item">Dish 3</div>
            <div class="carousel-item">Dish 4</div>
            <div class="carousel-item">Dish 5</div>
            <div class="carousel-item">Dish 6</div>
        </div>
        <button class="carousel-arrow right" onclick="scrollCarousel(1)">&#10095;</button>
    </div>
</div>

<script>
// Patch the getContext method to include willReadFrequently: true
(function () {
    const originalGetContext = HTMLCanvasElement.prototype.getContext;
    HTMLCanvasElement.prototype.getContext = function (type, options) {
        if (type === '2d') {
            options = { ...options, willReadFrequently: true };
        }
        return originalGetContext.call(this, type, options);
    };
})();

var scene, camera, renderer, clock, deltaTime, totalTime;
var arToolkitSource, arToolkitContext;
var markerRoot1;
var currentModel = null; // Track the currently loaded model

initialize();
animate();

function initialize() {
    scene = new THREE.Scene();

    let ambientLight = new THREE.AmbientLight(0xcccccc, 1.0);
    scene.add(ambientLight);

    camera = new THREE.Camera();
    scene.add(camera);

    renderer = new THREE.WebGLRenderer({
        antialias: true,
        alpha: true
    });
    renderer.setClearColor(new THREE.Color('lightgrey'), 0);
    renderer.setSize(document.getElementById('camera-section').clientWidth, document.getElementById('camera-section').clientHeight); // Set size to match the camera section
    renderer.domElement.style.position = 'absolute';
    renderer.domElement.style.top = '0px';
    renderer.domElement.style.left = '0px';
    document.getElementById('camera-section').appendChild(renderer.domElement);

    clock = new THREE.Clock();
    deltaTime = 0;
    totalTime = 0;

    // Setup AR toolkit source and context
    arToolkitSource = new THREEx.ArToolkitSource({
        sourceType: 'webcam',
    });

    arToolkitSource.init(function onReady() {
        console.log("arToolkitSource ready");
        onResize();
    }, function onError(error) {
        console.error('Error accessing the camera:', error);
        alert('Camera access denied. Please allow camera access to use AR features.');
    });

    window.addEventListener('resize', function () {
        onResize();
    });

    arToolkitContext = new THREEx.ArToolkitContext({
        cameraParametersUrl: 'data/camera_para.dat',
        detectionMode: 'mono'
    });

    arToolkitContext.init(function onCompleted() {
        console.log("arToolkitContext initialized");
        camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
    });

    // Setup marker root
    markerRoot1 = new THREE.Group();
    scene.add(markerRoot1);

    let markerControls1 = new THREEx.ArMarkerControls(arToolkitContext, markerRoot1, {
        type: 'pattern',
        patternUrl: "data/hiro.patt",
    });

    // Initialize Select2 for the dropdown
    $('#dropdown-menu').select2({
        placeholder: "Select a dish",
        allowClear: true
    });

    // Add event listener to the dropdown menu
    $('#dropdown-menu').on('change', function (event) {
        const selectedModel = event.target.value; // Get the selected model name
        loadModel(selectedModel); // Load the selected model
    });

    // Load the initial model (e.g., fish)
    loadModel('fish');
}

function loadModel(modelName) {
    // Remove the current model if it exists
    if (currentModel) {
        markerRoot1.remove(currentModel);
        currentModel = null;
    }

    if (modelName === 'cube') {
        // Create a cube programmatically
        const geometry = new THREE.BoxGeometry(1, 1, 1);
        const material = new THREE.MeshNormalMaterial({
            transparent: true,
            opacity: 0.5,
            side: THREE.DoubleSide
        });
        currentModel = new THREE.Mesh(geometry, material);
        currentModel.position.y = 0.5; // Adjust position
        markerRoot1.add(currentModel); // Add the cube to the marker
    } else if (modelName === 'fish') {
        // Load the fish model from .obj and .mtl files
        new THREE.MTLLoader()
            .setPath('models/')
            .load('fish.mtl', function (materials) {
                materials.preload();
                new THREE.OBJLoader()
                    .setMaterials(materials)
                    .setPath('models/')
                    .load('fish.obj', function (group) {
                        currentModel = group.children[0]; // Store the loaded model
                        currentModel.material.side = THREE.DoubleSide;
                        currentModel.position.y = 0.25;
                        currentModel.scale.set(0.25, 0.25, 0.25);
                        markerRoot1.add(currentModel); // Add the model to the marker
                    }, onProgress, onError);
            });
    }
}

function onProgress(xhr) {
    console.log((xhr.loaded / xhr.total * 100) + '% loaded');
}

function onError(xhr) {
    console.log('An error happened');
}

function update() {
    if (arToolkitSource.ready !== false)
        arToolkitContext.update(arToolkitSource.domElement);
}

function render() {
    renderer.render(scene, camera);
}

function animate() {
    requestAnimationFrame(animate);
    deltaTime = clock.getDelta();
    totalTime += deltaTime;
    update();
    render();
}

function onResize() {
    const cameraSection = document.getElementById('camera-section');
    renderer.setSize(cameraSection.clientWidth, cameraSection.clientHeight);

    // Replace deprecated arToolkitSource.onResize() with arToolkitSource.onResizeElement()
    arToolkitSource.onResizeElement();

    // Replace deprecated arToolkitSource.copySizeTo() with arToolkitSource.copyElementSizeTo()
    arToolkitSource.copyElementSizeTo(renderer.domElement);

    if (arToolkitContext.arController !== null) {
        arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas);
    }
}

// Carousel functionality
function scrollCarousel(direction) {
    const carousel = document.getElementById('carousel-container');
    const scrollAmount = 160; // Width of one item + margin
    carousel.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
}
</script>

</body>
</html>
